<div class="container" style="padding-top: 20px">
    <div style="margin-bottom: 20px; border-bottom: 2px solid #343a40; padding-bottom: 10px">
        <h2 style="margin: 0; font-weight: 700; color: #343a40">ë²„ìŠ¤ ë…¸ì„  ê´€ì œ</h2>
    </div>

    <div class="bus-dashboard-search">
        <div class="bus-radio-wrap">
            <label class="bus-radio-label">
                <input type="radio" ng-model="searchType" value="route" />
                <span>ğŸšŒ ë²„ìŠ¤</span>
            </label>

            <label class="bus-radio-label">
                <input type="radio" ng-model="searchType" value="stop" />
                <span>ğŸš ì •ë¥˜ì¥</span>
            </label>

            <button
                type="button"
                ng-click="toggleTramLayer()"
                class="btn-tram-toggle"
                ng-class="{'active': isTramVisible}"
            >
                ğŸš‹ íŠ¸ë¨ {{ isTramVisible ? 'ì§€ìš°ê¸°' : 'ë³´ì´ê¸°' }}
            </button>

            <button
                type="button"
                ng-click="solvePath()"
                class="btn-path-action"
                style="background-color: #28a745; color: white; border: none; padding: 8px 12px; border-radius: 4px; font-weight: bold; cursor: pointer; margin-left: 10px;"
                title="ì„ íƒí•œ ì¶œë°œ/ë„ì°© ì •ë¥˜ì¥ìœ¼ë¡œ ê²½ë¡œ íƒìƒ‰"
            >
                ğŸ§­ ê²½ë¡œ íƒìƒ‰
            </button>

            <button
                type="button"
                ng-click="clearResultPath()"
                class="btn-path-action danger"
                style="background-color: #dc3545; color: white; border: none; padding: 8px 12px; border-radius: 4px; font-weight: bold; cursor: pointer; margin-left: 5px;"
                title="ê²½ë¡œ ë° ì„ íƒ ì´ˆê¸°í™”"
            >
                ğŸ§¹ ì´ˆê¸°í™”
            </button>
        </div>

        <div class="bus-search-input-wrap">
            <input
                type="text"
                ng-model="searchKeyword"
                placeholder="{{ searchType == 'route' ? 'ë²„ìŠ¤ ë²ˆí˜¸ ì…ë ¥ (ì˜ˆ: 202)' : 'ì •ë¥˜ì¥ ì´ë¦„ ì…ë ¥' }}"
                class="bus-dashboard-input"
                ng-keyup="$event.keyCode == 13 && doSearch()"
            />

            <button type="button" ng-click="doSearch()" class="btn-bus-action">
                ê²€ìƒ‰
            </button>
        </div>
    </div>

    <div style="background: #e9ecef; padding: 10px; margin-top: 10px; border-radius: 4px; border: 1px solid #ced4da; font-size: 14px;">
        <strong>[í˜„ì¬ ê²½ë¡œ ì„¤ì •]</strong> 
        ì¶œë°œ: <span style="color: #007bff; font-weight: bold;">{{ pathStartStop.nodenm || pathStartStop.stationName || 'ë¯¸ì„ íƒ' }}</span> 
        â†’ 
        ë„ì°©: <span style="color: #dc3545; font-weight: bold;">{{ pathEndStop.nodenm || pathEndStop.stationName || 'ë¯¸ì„ íƒ' }}</span>
        
        <span ng-if="!pathStartStop || !pathEndStop" style="color: #666; margin-left: 10px;">(ëª©ë¡ì—ì„œ 'ì¶œë°œ'/'ë„ì°©' ë²„íŠ¼ì„ ëˆŒëŸ¬ ì„ íƒí•˜ì„¸ìš”)</span>
    </div>

    <div class="bus-status-container" style="display: flex; gap: 15px; margin-top: 15px; margin-bottom: 15px;">
        <div class="bus-card info-section" style="flex: 1; background: white; padding: 15px; border-radius: 8px; border: 1px solid #ddd; display: flex; align-items: center;">
            <div ng-if="representativeBus" style="display: flex; width: 100%; gap: 20px; align-items: center;">
                <div class="status-item">
                    <span class="status-label" style="font-size: 12px; color: #666; display: block;">ëŒ€í‘œì°¨ëŸ‰</span>
                    <span class="status-value" style="color: #007bff; font-weight: bold; font-size: 16px;">
                        {{ representativeBus.vehicleno || '-' }}
                    </span>
                </div>
                <div class="status-item">
                    <span class="status-label" style="font-size: 12px; color: #666; display: block;">ë…¸ì„ </span>
                    <span class="status-value" style="font-weight: bold; font-size: 16px;">{{ representativeBus.routenm || '-' }}</span>
                </div>
                <div class="status-item" style="flex: 1">
                    <span class="status-label" style="font-size: 12px; color: #666; display: block;">í˜„ì¬ ìœ„ì¹˜</span>
                    <span class="status-value" style="font-weight: bold; font-size: 16px;">
                        {{ (currentStop && currentStop.nodenm) || 'ì£¼í–‰ ì¤‘...' }}
                    </span>
                </div>
            </div>

            <div ng-if="!representativeBus" style="color: #999; font-size: 13px; font-style: italic">
                ìš´í–‰ ì¤‘ì¸ ë²„ìŠ¤ê°€ ì—†ê±°ë‚˜ ê²€ìƒ‰ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.
            </div>
        </div>

        <div class="bus-card control-section" style="background: white; padding: 15px; border-radius: 8px; border: 1px solid #ddd; display: flex; align-items: center; gap: 10px;">
            
            <button
                type="button"
                ng-click="enableAutoRefresh()"
                ng-disabled="isAutoRefreshOn"
                style="padding: 6px 10px; border-radius: 4px; border: 1px solid #28a745; background: white; color: #28a745; cursor: pointer;"
                ng-style="isAutoRefreshOn ? {'background':'#28a745', 'color':'white'} : {}"
            >
                â–¶ ìë™ê°±ì‹ 
            </button>

            <button
                type="button"
                ng-click="disableAutoRefresh()"
                ng-disabled="!isAutoRefreshOn"
                style="padding: 6px 10px; border-radius: 4px; border: 1px solid #dc3545; background: white; color: #dc3545; cursor: pointer;"
            >
                â¸ ë©ˆì¶¤
            </button>

            <div class="collector-wrap" style="padding-left: 15px; border-left: 1px solid #eee; display: flex; align-items: center; gap: 10px;">
                <span style="font-size: 12px; font-weight: bold; color: #555;">ìˆ˜ì§‘:</span>
                <button
                    type="button"
                    ng-click="toggleCollector()"
                    style="padding: 6px 10px; border-radius: 4px; cursor: pointer; border: 1px solid #6610f2; color: #6610f2; background: white;"
                    ng-class="collectorStatus && collectorStatus.running ? 'off' : 'on'"
                    ng-style="collectorStatus.running ? {'background':'#6610f2', 'color':'white'} : {}"
                >
                    {{ (collectorStatus && collectorStatus.running) ? 'â¹ ì¤‘ì§€' : 'â–¶ ì‹œì‘' }}
                </button>
                <div class="collector-status-text" style="font-size: 12px; color: #888;">
                    {{ collectorStatusText }}
                </div>
            </div>
        </div>
    </div>

    <div class="bus-map-frame" style="position: relative; width: 100%; height: 600px; border: 1px solid #ccc; border-radius: 4px; overflow: hidden;">
        <div id="map1" class="bus-map-canvas" style="width: 100%; height: 100%;"></div>

        <div class="map-loading-badge" ng-show="isMapLoading"
             style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(0,0,0,0.7); color: white; padding: 10px 20px; border-radius: 20px; z-index: 1000;">
            ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...
        </div>
    </div>

    <div class="bus-info-grid" style="display: flex; gap: 15px; margin-top: 15px; height: 300px;">
        
        <div class="bus-panel-box" style="flex: 1; background: white; border: 1px solid #ddd; border-radius: 8px; display: flex; flex-direction: column;">
            <div class="bus-panel-header accent-blue" style="padding: 10px; background: #f8f9fa; border-bottom: 1px solid #ddd; font-weight: bold; border-left: 4px solid #007bff;">
                <span>ğŸ“ ëª©ë¡</span>
                <span style="font-size: 12px; font-weight: 400; color: #666; margin-left: 5px;" ng-if="stops.length">
                    (ì´ {{ stops.length }}ê°œ)
                </span>
            </div>

            <div class="bus-panel-content" style="flex: 1; overflow-y: auto; padding: 0;">
                <ul class="stop-list" ng-if="stops && stops.length" style="list-style: none; padding: 0; margin: 0;">
                    <li ng-repeat="s in stops track by $index"
                        ng-click="selectStop(s)"
                        style="padding: 10px; border-bottom: 1px solid #eee; cursor: pointer; display: flex; align-items: center;"
                        ng-style="selectedStop === s ? {'background':'#e7f1ff'} : {}">
                        
                        <strong style="margin-right: 5px; color: #007bff; min-width: 20px;">{{$index + 1}}.</strong>
                        
                        <span style="flex: 1;">{{ s.nodenm || s.stationName || 'ì´ë¦„ ì—†ìŒ' }}</span>
                        
                        <div style="display: flex; gap: 5px; margin-right: 10px;">
                            <button type="button" 
                                    ng-click="$event.stopPropagation(); setPathStart(s)" 
                                    style="padding: 2px 6px; font-size: 11px; border: 1px solid #007bff; background: white; color: #007bff; border-radius: 4px; cursor: pointer;">
                                ì¶œë°œ
                            </button>
                            <button type="button" 
                                    ng-click="$event.stopPropagation(); setPathEnd(s)" 
                                    style="padding: 2px 6px; font-size: 11px; border: 1px solid #dc3545; background: white; color: #dc3545; border-radius: 4px; cursor: pointer;">
                                ë„ì°©
                            </button>
                        </div>

                        <small style="color: #999;">{{ s.nodeid || s.nodeId }}</small>
                    </li>
                </ul>

                <div class="panel-empty-msg" ng-if="!stops || !stops.length" style="padding: 20px; text-align: center; color: #999;">
                    ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.
                </div>
            </div>
        </div>

        <div class="bus-panel-box" style="flex: 1; background: white; border: 1px solid #ddd; border-radius: 8px; display: flex; flex-direction: column;">
            <div class="bus-panel-header accent-green" style="padding: 10px; background: #f8f9fa; border-bottom: 1px solid #ddd; font-weight: bold; border-left: 4px solid #28a745;">
                <span>â±ï¸ ë„ì°© ì˜ˆì • ì •ë³´</span>
                <span style="font-size: 12px; font-weight: 400; color: #666; margin-left: 5px;" ng-if="currentStop">
                    - {{ currentStop.nodenm }}
                </span>
            </div>

            <div class="bus-panel-content" style="flex: 1; overflow-y: auto; padding: 0;">
                <table class="arrival-info-table" ng-if="arrivalList && arrivalList.length" style="width: 100%; border-collapse: collapse;">
                    <thead style="background: #f8f9fa; font-size: 13px; color: #555;">
                        <tr>
                            <th style="padding: 8px; text-align: left;">ë…¸ì„ </th>
                            <th style="padding: 8px; text-align: center;">ìœ„ì¹˜</th>
                            <th style="padding: 8px; text-align: right;">ë„ì°© ì˜ˆì •</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr ng-repeat="a in arrivalList" style="border-bottom: 1px solid #eee;">
                            <td style="padding: 8px;"><strong>{{ a.routeno || a.routenm || '-' }}</strong></td>
                            <td style="padding: 8px; text-align: center;">
                                <span style="font-size: 12px; background: #f1f3f5; padding: 3px 6px; border-radius: 4px; color: #555;">
                                    {{ a.remainStops != null ? a.remainStops + 'ë²ˆì§¸ ì „' : '-' }}
                                </span>
                            </td>
                            <td style="padding: 8px; text-align: right;">
                                <span style="color: #d63384; font-weight: bold;" ng-if="a.remainMinutes != null">
                                    ì•½ {{ a.remainMinutes }}ë¶„ í›„
                                </span>
                                <span ng-if="a.remainMinutes == null">
                                    {{ a.arrtime ? (a.arrtime + 'ì´ˆ í›„') : '-' }}
                                </span>
                            </td>
                        </tr>
                    </tbody>
                </table>

                <div class="panel-empty-msg" ng-if="!currentStop" style="padding: 20px; text-align: center; color: #999;">
                    ì™¼ìª½ ëª©ë¡ì—ì„œ ì •ë¥˜ì¥ì„ ì„ íƒí•´ì£¼ì„¸ìš”.
                </div>

                <div class="panel-empty-msg" ng-if="currentStop && (!arrivalList || !arrivalList.length)" style="padding: 20px; text-align: center; color: #999;">
                    í˜„ì¬ ë„ì°© ì˜ˆì •ì¸ ë²„ìŠ¤ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.
                </div>
            </div>
        </div>
    </div>
</div>