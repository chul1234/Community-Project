<!-- ìˆ˜ì •ë¨: ìˆ˜ì§‘ UIë¥¼ ì„œë²„ ìë™ ìˆ˜ì§‘(toggle/status) êµ¬ì¡°ì— ë§ê²Œ ë³€ê²½ (batch ì…ë ¥/1íšŒ ìˆ˜ì§‘ ì œê±°, í† ê¸€ 1ê°œ + ìƒíƒœ í‘œì‹œ) -->

<div class="container" style="padding-top: 20px">
    <div style="margin-bottom: 20px; border-bottom: 2px solid #343a40; padding-bottom: 10px">
        <h2 style="margin: 0; font-weight: 700; color: #343a40">ë²„ìŠ¤ ë…¸ì„  ê´€ì œ</h2>
    </div>

    <!-- ================= ê²€ìƒ‰ ì˜ì—­ ================= -->
    <div class="bus-dashboard-search">
        <!-- ë²„ìŠ¤ / ì •ë¥˜ì¥ / íŠ¸ë¨ í† ê¸€ ì˜ì—­ -->
        <div class="bus-radio-wrap">
            <label class="bus-radio-label">
                <input type="radio" ng-model="searchType" value="route" />
                <span>ğŸšŒ ë²„ìŠ¤</span>
            </label>

            <label class="bus-radio-label">
                <input type="radio" ng-model="searchType" value="stop" />
                <span>ğŸš ì •ë¥˜ì¥</span>
            </label>

            <!-- íŠ¸ë¨ ë…¸ì„  í† ê¸€ ë²„íŠ¼ -->
            <button
                type="button"
                ng-click="toggleTramLayer()"
                class="btn-tram-toggle"
                ng-class="{'active': isTramVisible}"
            >
                ğŸš‹ íŠ¸ë¨ {{ isTramVisible ? 'ì§€ìš°ê¸°' : 'ë³´ì´ê¸°' }}
            </button>
        </div>

        <input
            type="text"
            ng-model="searchKeyword"
            placeholder="{{ searchType == 'route' ? 'ë²„ìŠ¤ ë²ˆí˜¸ ì…ë ¥ (ì˜ˆ: 202)' : 'ì •ë¥˜ì¥ ì´ë¦„ ì…ë ¥' }}"
            class="bus-dashboard-input"
            ng-keyup="$event.keyCode == 13 && doSearch()"
        />

        <button type="button" ng-click="doSearch()" class="btn-bus-action">
            ê²€ìƒ‰
        </button>
    </div>

    <!-- ================= ìƒíƒœ ì˜ì—­ ================= -->
    <div class="bus-status-container">
        <div class="bus-card info-section">
            <div ng-if="representativeBus" style="display: flex; width: 100%; gap: 20px">
                <div class="status-item">
                    <span class="status-label">ëŒ€í‘œì°¨ëŸ‰</span>
                    <span class="status-value" style="color: #007bff">
                        {{ representativeBus.vehicleno || '-' }}
                    </span>
                </div>
                <div class="status-item">
                    <span class="status-label">ë…¸ì„ </span>
                    <span class="status-value">{{ representativeBus.routenm || '-' }}</span>
                </div>
                <div class="status-item" style="flex: 1">
                    <span class="status-label">í˜„ì¬ ìœ„ì¹˜</span>
                    <span class="status-value">
                        {{ (currentStop && currentStop.nodenm) || 'ì£¼í–‰ ì¤‘...' }}
                    </span>
                </div>
            </div>

            <div ng-if="!representativeBus" style="color: #999; font-size: 13px; font-style: italic">
                ìš´í–‰ ì¤‘ì¸ ë²„ìŠ¤ê°€ ì—†ê±°ë‚˜ ê²€ìƒ‰ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.
            </div>
        </div>

        <div class="bus-card control-section">
            <button
                type="button"
                ng-click="enableAutoRefresh()"
                ng-disabled="isAutoRefreshOn"
                class="btn-refresh-toggle on"
            >
                â–¶ ìë™ê°±ì‹ 
            </button>

            <button
                type="button"
                ng-click="disableAutoRefresh()"
                ng-disabled="!isAutoRefreshOn"
                class="btn-refresh-toggle off"
            >
                â¸ ë©ˆì¶¤
            </button>

            <div style="font-size: 12px; color: #888; align-self: center; white-space: nowrap">
                ìƒíƒœ: <strong>{{ isAutoRefreshOn ? 'ON' : 'OFF' }}</strong>
            </div>

            <!-- ================= ìˆ˜ì§‘ ì˜ì—­ (í† ê¸€ 1ê°œ + ìƒíƒœ í‘œì‹œ) ================= -->
            <div
                style="
                    margin-left: auto;
                    display: flex;
                    align-items: center;
                    gap: 10px;

                    white-space: nowrap;
                    word-break: keep-all;

                    max-width: 100%;
                    flex: 1 1 360px;

                    padding-left: 12px;
                    border-left: 1px solid #e9ecef;
                "
            >
                <div
                    style="
                        font-size: 12px;
                        color: #666;
                        font-weight: 700;
                        white-space: nowrap;
                        word-break: keep-all;
                        flex: 0 0 auto;
                    "
                >
                    ìˆ˜ì§‘:
                </div>

                <button
                    type="button"
                    ng-click="toggleCollector()"
                    class="btn-refresh-toggle"
                    ng-class="collectorStatus && collectorStatus.running ? 'off' : 'on'"
                    style="
                        min-width: 140px;
                        white-space: nowrap;
                        word-break: keep-all;
                        flex: 0 0 auto;
                    "
                >
                    {{ (collectorStatus && collectorStatus.running) ? 'â¹ ë°ì´í„° ìˆ˜ì§‘ ì¤‘ì§€' : 'â–¶ ë°ì´í„° ìˆ˜ì§‘ ì‹œì‘' }}
                </button>

                <div
                    style="
                        font-size: 12px;
                        color: #888;

                        white-space: normal;
                        word-break: keep-all;
                        overflow: visible;

                        display: -webkit-box;
                        -webkit-line-clamp: 2;
                        -webkit-box-orient: vertical;

                        max-width: 420px;
                        flex: 1 1 220px;
                        min-width: 220px;
                    "
                    title="{{ collectorStatusText }}"
                >
                    {{ collectorStatusText }}
                </div>
            </div>
            <!-- ================= ìˆ˜ì§‘ ì˜ì—­ ë ================= -->
        </div>
    </div>

    <!-- ================= ì§€ë„ ================= -->
    <div class="bus-map-frame">
        <div id="map1" class="bus-map-canvas"></div>

        <div class="map-loading-badge" ng-show="isMapLoading || isStopPollingLoading">
            ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...
        </div>
    </div>

    <!-- ================= í•˜ë‹¨ ì •ë³´ ================= -->
    <div class="bus-info-grid">
        <div class="bus-panel-box">
            <div class="bus-panel-header accent-blue">
                <span>ğŸ“ ì •ë¥˜ì¥ ëª©ë¡</span>
                <span style="font-size: 12px; font-weight: 400; color: #666" ng-if="stops.length">
                    ì´ {{ stops.length }}ê°œ
                </span>
            </div>

            <div class="bus-panel-content">
                <div ng-if="stops && stops.length">
                    <div
                        ng-repeat="s in stops track by $index"
                        ng-click="selectStop(s)"
                        class="stop-list-row"
                        ng-class="{'active': selectedStop === s}"
                    >
                        <strong style="margin-right: 10px; min-width: 25px; text-align: center">
                            {{$index + 1}}
                        </strong>
                        <span>{{ s.nodenm || s.stationName || 'ì •ë¥˜ì¥ëª… ì—†ìŒ' }}</span>
                        <span
                            style="
                                margin-left: auto;
                                font-size: 11px;
                                background: #eee;
                                padding: 2px 6px;
                                border-radius: 4px;
                                color: #666;
                            "
                        >
                            {{ s.nodeid || s.nodeId }}
                        </span>
                    </div>
                </div>

                <div class="panel-empty-msg" ng-if="!stops || !stops.length">
                    ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.
                </div>
            </div>
        </div>

        <div class="bus-panel-box">
            <div class="bus-panel-header accent-green">
                <span>â±ï¸ ë„ì°© ì˜ˆì • ì •ë³´</span>
                <span style="font-size: 12px; font-weight: 400; color: #666" ng-if="currentStop">
                    {{ currentStop.nodenm }} ê¸°ì¤€
                </span>
            </div>

            <div class="bus-panel-content">
                <table class="arrival-info-table" ng-if="arrivalList && arrivalList.length && currentStop">
                    <thead>
                        <tr>
                            <th width="30%">ë…¸ì„ </th>
                            <th width="30%">í˜„ì¬ ìœ„ì¹˜</th>
                            <th width="40%">ë„ì°© ì˜ˆì •</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr ng-repeat="a in arrivalList">
                            <td><strong>{{ a.routeno || a.routenm || '-' }}</strong></td>
                            <td>
                                <span style="font-size: 12px; background: #f1f3f5; padding: 3px 6px; border-radius: 4px">
                                    {{ a.remainStops != null ? a.remainStops + 'ë²ˆì§¸ ì „' : '-' }}
                                </span>
                            </td>
                            <td>
                                <span class="arrival-highlight" ng-if="a.remainMinutes != null">
                                    ì•½ {{ a.remainMinutes }}ë¶„ í›„
                                </span>
                                <span ng-if="a.remainMinutes == null">
                                    {{ a.arrtime ? (a.arrtime + 'ì´ˆ í›„') : '-' }}
                                </span>
                            </td>
                        </tr>
                    </tbody>
                </table>

                <div class="panel-empty-msg" ng-if="!currentStop">
                    ì™¼ìª½ ëª©ë¡ì—ì„œ ì •ë¥˜ì¥ì„ ì„ íƒí•´ì£¼ì„¸ìš”.
                </div>

                <div class="panel-empty-msg" ng-if="currentStop && (!arrivalList || !arrivalList.length)">
                    í˜„ì¬ ë„ì°© ì˜ˆì •ì¸ ë²„ìŠ¤ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ìˆ˜ì •ë¨ ë -->
