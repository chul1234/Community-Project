<div class="container">
    <div ng-if="!isEditing">
        <h1>{{ post.title }}</h1>
        <div style="color: #6c757d; margin-bottom: 20px; border-bottom: 1px solid #dee2e6; padding-bottom: 15px;">
            <span>ì‘ì„±ì: {{ post.author_name || 'íƒˆí‡´í•œ ì‚¬ìš©ì' }} ({{ post.user_id }})</span>
            <span style="margin-left: 15px;">ì¡°íšŒ: {{ post.view_count }}</span>
            
            <!-- â˜… ì¶”ê°€ë¨: ê²Œì‹œê¸€ ì¢‹ì•„ìš” ë²„íŠ¼ -->
            <span style="margin-left: 15px;">
                <button type="button"
                        class="action-btn-sm"
                        ng-click="togglePostLikeDetail(post)">
                    <span ng-class="{'liked': post.likeCount > 0}">â™¥</span>
                    {{ post.likeCount || 0 }}
                </button>
            </span>
            <!-- â˜… ì¶”ê°€ë¨ ë -->

            <span style="float: right;">ì‘ì„±ì¼: {{ post.created_at | date:'yyyy-MM-dd HH:mm' }}</span>
        </div>

        <div class="post-content"
             ng-bind-html="trustedContent"
             style="min-height: 200px; margin-bottom: 20px; white-space: pre-wrap;"></div>

        <!-- â˜… ì²¨ë¶€ íŒŒì¼ ì˜ì—­ ì‹œì‘: detailì—ì„œ ì—…ë¡œë“œí•œ íŒŒì¼ í‘œì‹œ -->
        <div class="attachments"
             ng-if="fileList && fileList.length > 0"
             style="margin-bottom: 20px;">
            <h3 style="font-size: 16px; margin-bottom: 8px;">ì²¨ë¶€ íŒŒì¼</h3>
            <ul>
                <li ng-repeat="file in fileList">
                    <!-- íŒŒì¼ ë‹¤ìš´ë¡œë“œ ë§í¬: ì‹¤ì œ ë‹¤ìš´ë¡œë“œ URLì— ë§ê²Œ ìˆ˜ì • ê°€ëŠ¥ -->
                    <a ng-href="/api/files/{{file.file_id}}/download">
                        {{ file.original_name }}
                    </a>
                    <span style="color: #6c757d; font-size: 12px;">
                        ({{ file.file_size | number }} bytes)
                    </span>
                </li>
            </ul>
        </div>
        <div class="attachments"
             ng-if="fileList && fileList.length === 0"
             style="margin-bottom: 20px; color: #6c757d; font-size: 14px;">
            ì²¨ë¶€ëœ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤.
        </div>
        <!-- â˜… ì²¨ë¶€ íŒŒì¼ ì˜ì—­ ë -->

        <div class="action-bar">
            <div ng-if="canModify">
                <button type="button" 
                        ng-click="switchToEditMode()"
                        ng-if="post.user_id === currentUser.username">ìˆ˜ì •</button>
                <button type="button" ng-click="deletePost()" class="delete-btn">ì‚­ì œ</button>

                <button type="button" 
                        ng-if="currentUser.role === 'ADMIN' && post.pinned_order === null"
                        ng-click="pinPost()">
                    ğŸ·ï¸ ê³ ì •í•˜ê¸°
                </button>
                
                <button type="button" 
                        ng-if="currentUser.role === 'ADMIN' && post.pinned_order !== null"
                        ng-click="unpinPost()" 
                        class="delete-btn">
                    ğŸ·ï¸ ê³ ì • í•´ì œ
                </button>
            </div>
            <a href="#!/board" class="action-btn">ëª©ë¡ìœ¼ë¡œ</a>
        </div>
    </div>

    <div ng-if="isEditing">
        <h1>ê²Œì‹œê¸€ ìˆ˜ì •</h1>
        <form name="editForm" novalidate>
            <div class="form-group">
                <label>ì œëª©</label>
                <input type="text" ng-model="editData.title" required class="form-control" />
            </div>
            <div class="form-group">
                <label>ë‚´ìš©</label>
                <textarea ng-model="editData.content" required rows="10" class="form-control" style="width: 100%;"></textarea>
            </div>
        </form>
        <div class="action-bar">
            <div class="button-group">
                <button type="button"
                        ng-click="saveChanges()"
                        ng-disabled="editForm.$invalid"
                        class="submit-btn-full">ìˆ˜ì • ì™„ë£Œ</button>
                <!-- â˜… ìˆ˜ì •ë¨: cancelEdit() â†’ exitEditMode() (ì»¨íŠ¸ë¡¤ëŸ¬ í•¨ìˆ˜ëª…ê³¼ ë§ì¶¤) -->
                <button type="button"
                        ng-click="exitEditMode()"
                        class="secondary-btn">ì·¨ì†Œ</button>
            </div>
        </div>
    </div>

    <hr> 
    
    <div class="comments-section">
        <h2>ëŒ“ê¸€</h2>

        <div class="comment-form">
            <form name="commentForm">
                <textarea ng-model="newComment.content" required placeholder="ëŒ“ê¸€ì„ ì…ë ¥í•˜ì„¸ìš”" class="form-control" rows="4"></textarea>
                <button ng-click="submitComment(null, newComment)"
                        ng-disabled="commentForm.$invalid"
                        class="submit-btn"
                        style="width: 100%; margin-top: 10px;">
                    ëŒ“ê¸€ ë“±ë¡
                </button>
            </form>
        </div>

        <div class="comment-list" style="margin-top: 30px;">
            <div ng-if="!comments.length" class="no-comments">
                ì•„ì§ ëŒ“ê¸€ì´ ì—†ìŠµë‹ˆë‹¤. ì²« ëŒ“ê¸€ì„ ì‘ì„±í•´ë³´ì„¸ìš”!
            </div>
            
            <div ng-repeat="comment in comments" ng-include="'comment-tree.html'"></div>
        </div>

    </div>
</div>

<script type="text/ng-template" id="comment-tree.html">
    <div class="comment-item" ng-if="!comment.isEditing">
        <div class="comment-header">
            <strong>{{ comment.author_name ||'íƒˆí‡´í•œ ì‚¬ìš©ì' }}</strong> ({{ comment.user_id }})
            <span class="comment-date">{{ comment.created_at | date:'yyyy-MM-dd HH:mm' }}</span>
            
            <!-- â˜… ì¶”ê°€ë¨: ëŒ“ê¸€/ëŒ€ëŒ“ê¸€ ì¢‹ì•„ìš” ë²„íŠ¼ -->
            <span class="comment-like" style="margin-left: 10px;">
                <button type="button"
                        class="action-btn-sm"
                        ng-click="toggleCommentLike(comment)">
                    <span ng-class="{'liked': comment.likeCount > 0}">â™¥</span>
                    {{ comment.likeCount || 0 }}
                </button>
            </span>
            <!-- â˜… ì¶”ê°€ë¨ ë -->
        </div>
        <p class="comment-content">{{ comment.content }}</p>
        
        <div class="comment-actions">
            <button ng-click="comment.showReply = !comment.showReply" class="action-btn-sm">ë‹µê¸€</button>
            
            <span ng-if="canModifyComment(comment)">
                <button ng-click="switchToCommentEditMode(comment)" class="action-btn-sm" 
                        ng-if="comment.user_id === currentUser.username">ìˆ˜ì •</button>
                <button ng-click="deleteComment(comment.comment_id)" class="action-btn-sm delete">ì‚­ì œ</button>
            </span>
        </div>
    </div>

    <div class="comment-item" ng-if="comment.isEditing">
        <textarea ng-model="comment.editContent"
                  class="form-control"
                  rows="3"
                  style="width: 100%; box-sizing: border-box;"></textarea>
        <div class="comment-actions" style="margin-top: 5px;">
            <button ng-click="saveCommentChanges(comment)" class="action-btn-sm save">ì €ì¥</button>
            <button ng-click="cancelCommentEdit(comment)" class="action-btn-sm">ì·¨ì†Œ</button>
        </div>
    </div>

    <div class="comment-form"
         ng-if="comment.showReply"
         style="margin-left: 30px; margin-top: 10px; margin-bottom: 10px;">
        <form name="replyForm_{{comment.comment_id}}">
            <textarea ng-model="comment.replyContent"
                      required
                      placeholder="{{comment.author_name}}ë‹˜ì—ê²Œ ë‹µê¸€ ë‚¨ê¸°ê¸°"
                      class="form-control"
                      rows="3"></textarea>
            
            <button ng-click="submitComment(comment.comment_id, { content: comment.replyContent })" 
                    ng-disabled="!comment.replyContent" 
                    class="submit-btn"
                    style="width: auto; margin-top: 10px; padding: 6px 12px;">
                ë‹µê¸€ ë“±ë¡
            </button>
            
            <button ng-click="comment.showReply = false; comment.replyContent = '';" 
                    class="secondary-btn"
                    style="width: auto; margin-top: 10px; background-color: #6c757d; padding: 6px 12px;">
                ì·¨ì†Œ
            </button>
        </form>
    </div>

    <div class="replies" style="margin-left: 30px; border-left: 2px solid #eee; padding-left: 10px;" 
         ng-if="comment.replies && comment.replies.length > 0">
        
        <div ng-repeat="comment in comment.replies" ng-include="'comment-tree.html'"></div>
    </div>
</script>
